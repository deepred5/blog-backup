---
title: 再谈前后端分离部署
date: 2020-02-28 14:29:07
tags: [前端]
---
前后端分离开发已成为业界的共识，但分离的同时也带来了部署的问题。传统web模式下，前端和后端同属一个项目，模板的渲染理所当然由后端渲染。然而随着node的流行，以及webpack的模块化打包方案，让前端在**开发阶段**完全有能力脱离后端环境：通过本地node启动一个服务器，搭配Mock数据，马上就可以进行业务开发了。

但是到了**部署阶段**，问题也就显现出来：前端最后打包出来的js，css以及index.html，到底放在哪里？静态文件js，css或者图片，我们还可以在CI阶段上传到cdn服务器上，但是最后的html模板`index.html`一定需要放在一个服务器上，然而这个服务器到底由前端还是后端维护？

### 前端维护HTML
如果html模板由前端维护，那么前端就需要自己使用一个静态服务器：提供`HTML`的渲染和`API`接口的转发。常见的单页应用，也是推荐使用Nginx进行部署。

使用Nginx部署，这里又分两种情况：
* 静态资源完全由Nginx托管，也就是js,css和index.html放在同一个`dist`目录里。在这种情况下，webpack的`publicPath`一般不用特别设置，使用默认的`/`即可。
* 静态资源上传CDN，Nginx只提供`index.html`。在这种情况下，webpack的`publicPath`要设置成cdn的地址，例如:`//static.demo.cn/activity/share/`。但这又会引发一个问题，由于qa环境，验证环境，生产环境的cdn地址通常不同，为了让`index.html`可以引入正确的静态文件路径，你需要打包三次，仅仅为了生成三份引用了不同路径的html(即使三次打包的js内容完全一样)

`nginx配置`
```bash
server {
    listen       80;
    server_name  localhost;

    location / {
        root   /app/dist; # 打包的路径
        index  index.html index.htm;
        try_files $uri $uri/ /index.html; # 单页应用防止重刷新返回404，如果是多页应用则无需这条命令
    }

    location /api {
        proxy_pass https://anata.me; #后台转发地址
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Real-IP         $remote_addr;
    }
}
```
理论上qa，yz，prod环境的转发接口地址也不同，因此你也需要有三份`nginx.conf`配置

### 后端维护HTML
很多情况下，我们需要渲染的HTML页面带上一些后端动态注入的数据（在多页应用中尤其常见），又或者页面需要SEO支持，这种情况下，我们只能把`index.html`交给后端管理。那么后端维护的html模板怎么获取打包后的hash值呢？
* 前端打包后的`index.html`直接发给后端(<font color="red">简单粗暴，并不推荐<font>)
* 前端打包时通过插件`webpack-manifest-plugin`后生成一个`manifest.json`文件，记录了文件的真正hash值
```javascript
{
  "main.css": "main.198b3634.css",
  "main.js": "main.d312f172.js",
}
```
后端的`index.html`
```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>demo</title>
  <link href="<%= bundle['main.css']%>" rel="stylesheet">
</head>

<body>
  <h1>demo</h1>
  <script src="<%= bundle['main.js'] %>"></script>
</body>
</html>
```
后端通过读取这个`json`文件，可以动态渲染出真正的文件引用路径。

使用这种方法还有一个好处：前面我们说过，如果文件上传至cdn，那么前端维护的html可能需要打包三次，因为不同环境的cdn地址不同。现在html交给后端维护了，那么这个问题就很好解决，前端只需要打包一次，不同环境的cdn地址可以让后端动态拼接生成。

当然，使用这种方法也会带来一个问题，这个json文件，后端怎么获取？

* 把这个json文件和其他静态资源一起打包上传到cdn上，后端服务器每次启动时，先到cdn上获取这个json文件，然后存到内存里
```bash
wget --tries=3 --quiet -O manifest.json http://static.demo.cn/demo/manifest.json?`date +%s` ## 防止缓存
```
这种方案的缺点是：如果`manifest.json`更新了，后端则需要重启服务。尤其当集群多的时候，重启耗费的代价就很高了。

* 使用配置中心，将`manifest.json`的内容存储起来，后端接入配置中心即可。每次CI打包后，更新配置中心的内容即可。这样就可以免重启服务了。

在公司中，这两种方案均有实现。